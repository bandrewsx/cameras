// Initialize the map
const map = L.map('map').setView([40.015, -105.2705], 13);

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

const videoContainer = document.getElementById('video-container');
const videoElement = document.getElementById('camera-video');
const closeBtn = document.getElementById('close-btn');
const urlParams = new URLSearchParams(window.location.search);

let player; // Video.js player instance

// Add camera markers to the map
cameras.forEach(camera => {
  if (camera.latitude && camera.longitude) {
    const marker = L.marker([camera.latitude, camera.longitude]).addTo(map);
    marker.bindPopup(camera.name);
    marker.on('click', () => openCamera(camera));
  } else {
    console.warn(`Camera ${camera.id} is missing coordinates and won't be added to the map.`);
  }
});

// Open the camera stream
function openCamera(camera) {
  // Dispose of the existing Video.js player instance
  if (player) {
    player.dispose();
    player = null;
  }

  // Show the video container
  videoContainer.classList.add('active');

  // Clear previous video source and configure the new one
  videoElement.innerHTML = ''; // Clear any existing <source> elements
  const source = document.createElement('source');
  source.src = camera.stream;
  source.type = 'application/x-mpegURL';
  videoElement.appendChild(source);

  // Set the video poster
  videoElement.setAttribute('poster', camera.thumbnail);

  // Initialize Video.js with the updated video element
  player = videojs(videoElement, {
    autoplay: true,
    controls: true,
  });

  // Update the URL with the selected camera's ID
  history.replaceState(null, '', `?camera-id=${camera.id}`);
}

// Close the video container
closeBtn.addEventListener('click', () => {
  if (player) {
    player.dispose(); // Dispose of the current player instance
    player = null;
  }
  videoContainer.classList.remove('active'); // Hide the video container
  history.replaceState(null, '', window.location.pathname); // Remove camera-id from URL
});

// Check for ?camera-id in the URL and open the corresponding camera
const cameraId = urlParams.get('camera-id');
if (cameraId) {
  const camera = cameras.find(cam => cam.id === cameraId);
  if (camera) {
    openCamera(camera);
  } else {
    console.warn(`No camera found with ID: ${cameraId}`);
  }
}
